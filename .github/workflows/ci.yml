name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ðŸ§ª Tests & QualitÃ©
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx

      - name: Run tests with coverage
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ -v --cov=app --cov=model --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
        continue-on-error: true

  train:
    name: ðŸ¤– EntraÃ®nement & Validation ModÃ¨le
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Train & validate model
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -c "
          from model.train import train_and_log
          metrics = train_and_log()
          print('Metrics:', metrics)
          assert metrics['accuracy'] > 0.70, f'Accuracy trop faible: {metrics[\"accuracy\"]}'
          assert metrics['roc_auc'] > 0.75, f'AUC trop faible: {metrics[\"roc_auc\"]}'
          print('Modele valide â€” Accuracy:', metrics['accuracy'], '| AUC:', metrics['roc_auc'])
          "

      - name: Upload trained model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model/saved_model.pkl

  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, train]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download model artifact
        uses: actions/download-artifact@v3
        with:
          name: trained-model
          path: model/

      - name: Build Docker image
        run: docker build -t mlops-portfolio:${{ github.sha }} .

      - name: Deploy notification
        run: echo "Build Docker OK pour le commit ${{ github.sha }}"
